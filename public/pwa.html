<html>
  <head>
    <title>PWAmaker PWA Loader</title>
    <script>
      function isPWA() {
        return window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
      }

      async function encodeImageToBase64(imagePath) {
        try {
          const response = await fetch(imagePath);
          if (!response.ok) throw new Error('Failed to fetch the image');
          const blob = await response.blob();

          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error("Error encoding image to Base64:", error);
        }
      }

      var defaultData = {
        "name": "YouTube",
        "description": "YouTube videos and shorts",
        "url": "https://youtube.com",
      };

      const params = new URLSearchParams(window.location.search);
      var data;

      try {
        const dataParam = params.get("data");
        data = dataParam ? JSON.parse(decodeURIComponent(dataParam)) : defaultData;
      } catch (error) {
        console.error("Error parsing data: " + error);
        data = defaultData;
      }

      encodeImageToBase64('favicon.png').then(base64String => {
        data.icon = params.get("icon") ?? base64String;
      });

      if (isPWA()) {
        console.log("Loading PWA with " + JSON.stringify(data));
        debugger;
        window.location.href = data.url;
      } else {
        console.log("Loaded data with: " + JSON.stringify(data));
      }
    </script>
  </head>
  <body>
    <h1 id="title">Loading...</h1>
    <p id="desc">Loading...</p>

    <script>
      var manifest = {
        name: data.name,
        short_name: data.name,
        display: "standalone",
        background_color: "#ffffff",
        theme_color: "#000000",
        icons: [
          {
            src: "data:image/png;base64," + data.icon,
            type: "image/png",
            sizes: "192x192"
          },
        ]
      };

      if (!isPWA()) {
        var manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest));
        document.head.appendChild(manifestLink);

        document.getElementById("title").textContent = data.name + " - " + data.url;
        document.getElementById("desc").textContent = data.desc;
        document.getElementById("icon").src = "data:image/png;base64," + data.icon;
      }
    </script>
  </body>
</html>