<html>
  <head>
    <title>PWAmaker PWA Loader</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <style>
      :root {
        --bg-light: #ffffff;
        --bg-dark: #1f1f1f;
        --text-light: #141414;
        --text-dark: #ffffff;
        --link-light: #ff6600;
        --link-dark: #ff6600;
        --popup-transition: 0.2s;
      }

      html {
        font-family: 'Courier New', Courier, monospace;
        overflow-x: hidden;
        overflow-y: auto;
      }

      /* Default to light mode */
      body {
        background-color: var(--bg-light);
        color: var(--text-light);
        font-family: Arial, sans-serif;
      }

      /* Style links */
      a {
        color: var(--link-light);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      button {
        color: black;
        border: 2px solid var(--text-light);
        border-radius: 5px;
        background-color: white;
        transition: transform 0.25s ease-in-out;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
      }

      button:hover:not(.cupertino-design) {
        transform: scale(1.1);
      }

      #icon {
        box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.5);
        width: 100px;
        height: 100px;
        border-radius: 15px;
      }

      #install.web-design {
        width: 150px;
        height: 75px;
        font-size: 20px;
        color: white;
        background-color: gray;
        box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.5);
      }

      #install.cupertino-design {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        color: white;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        background-color: gray;
        box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.5);
        transition: background-color 0.3s ease, transform 0.3s ease;
      }

      #install.cupertino-design:hover {
        transform: translateY(-2px);
      }

      #install.cupertino-design:active {
        transform: translateY(0);
      }

      #install.cupertino-design .icon {
        margin-right: 8px;
      }

      .installable {
        background-color: #007aff !important;
      }

      #popupOverlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          opacity: 0;
          visibility: hidden;
          transition: opacity var(--popup-transition) ease, visibility var(--popup-transition) ease;
      }

      #popupOverlay.visible {
          opacity: 1;
          visibility: visible;
      }

      #popup {
          color: black;
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
          transform: scale(0.8);
          transition: transform var(--popup-transition) ease;
          max-width: 90%;
          max-height: 90%;
          overflow-x: hidden;
          overflow-y: auto;
      }

      #popupOverlay.visible #popup {
          transform: scale(1);
      }

      #closePopup {
          position: absolute;
          top: 10px;
          right: 10px;
          font-size: 24px;
          cursor: pointer;
      }

      /* Dark mode styles */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: var(--bg-dark);
          color: var(--text-dark);
        }

        a {
          color: var(--link-dark);
        }

        a:hover {
          text-decoration: underline;
        }

        button {
          border: 2px solid var(--text-dark);
        }
      }
    </style>
  </head>
  <body>
    <div style="margin: auto; text-align: center; margin-top: 25px;">
      <image id="icon" src="/icons/placeholder/more_horiz.png"></image>
      <h1 id="title" style="margin-bottom: 0px;">Loading...</h1>
      <h2 id="url" style="margin-top: 0px;">Loading...</h2>
      <p id="desc">Loading...</p>
      <br>
      <button id="install" class="cupertino-design" onclick="install();">Install</button>
    </div>

    <!-- I used ChatGPT for the entire popup animation and box, I'm just gonna admit it up front -->
    <div id="popupOverlay" class="hidden">
      <div id="popup">
        <span id="closePopup">&times;</span>
        <h2>How to Install</h2>
        <div id="installDialogue" style="margin-bottom: 15px;">Loading...</div>
        <button id="dismissPopup">Dismiss</button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
          const closePopup = document.getElementById("closePopup");
          const dismissPopup = document.getElementById("dismissPopup");
          const popupOverlay = document.getElementById("popupOverlay");

          // Hide popup
          const hidePopup = () => {
            popupOverlay.classList.remove("visible");
          };

          closePopup.addEventListener("click", hidePopup);
          dismissPopup.addEventListener("click", hidePopup);

          // Hide popup on clicking outside of it
          popupOverlay.addEventListener("click", (e) => {
            if (e.target === popupOverlay) {
              hidePopup();
            }
          });

          var installDialogue = `To install this website as an app, you will first need to share the website to your home screen. On mobile, click the share button or icon, and press "Add to Home Screen". Follow the steps and continue. If you are on desktop, then sharing will vary by browser, but you want to look for something like "Install as App" or "Add to Dock".`;

          document.getElementById("installDialogue").innerHTML = installDialogue;
      });

      function isPWA() {
        return window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
      }

      async function encodeImageToBase64(imagePath) {
        try {
          const response = await fetch(imagePath);
          if (!response.ok) throw new Error('Failed to fetch the image');
          const blob = await response.blob();

          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error("Error encoding image to Base64:", error);
        }
      }

      var defaultData = {
        "name": "Calebh101",
        "desc": "Calebh101 website",
        "url": "https://calebh101studios.web.app",
      };

      var installable = false;
      const params = new URLSearchParams(window.location.search);
      var data;
      var iconParam = decodeURIComponent(params.get("icon"));

      try {
        const dataParam = params.get("data");
        data = dataParam ? JSON.parse(decodeURIComponent(dataParam)) : defaultData;
      } catch (error) {
        console.error("Error parsing data: " + error);
        data = defaultData;
      }

      data.name ??= defaultData.name;
      data.desc ??= defaultData.desc;
      data.icon = params.get("icon") ? "data:image/png;base64," + iconParam : "/icons/pwamaker/small-full.png";

      if (isPWA()) {
        console.log("Loading PWA with " + JSON.stringify(data));
        debugger;
        window.location.href = data.url;
      } else {
        console.log("Loaded data with: " + JSON.stringify(data));
      }

      var manifest = {
        name: data.name,
        short_name: data.name,
        description: data.desc,
        display: "standalone",
        background_color: "#ffffff",
        theme_color: "#000000",
        icons: [
          {
            src: data.icon,
            type: "image/png",
            sizes: "1024x1024"
          },
        ]
      };

      if (!isPWA()) {
        console.log("PWA ready");

        var manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest));
        document.head.appendChild(manifestLink);

        document.getElementById("title").innerHTML = data.name;
        document.getElementById("url").innerHTML = "<a target='_blank' href='" + data.url + "'>" + data.url + "</a>";
        document.getElementById("desc").innerHTML = data.desc;
        document.getElementById("icon").src = data.icon;
        document.getElementById("install").classList.add("installable");

        installable = true;
      }

      function install() {
        if (installable) {
          console.log("installing...");
          popupOverlay.classList.add("visible");
        }
      }
    </script>
  </body>
</html>